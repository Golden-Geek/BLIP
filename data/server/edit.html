<!-- Version 1.1.2 -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>BLIP Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="dark" />
  <script src="osc-mini.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <link rel="stylesheet" href="edit.css" />
</head>

<body>
  <div class="shell">
    <!-- Top controls -->
    <div class="card">
      <div class="card-inner">
        <div class="header-row">
          <div class="chip" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <rect x="4" y="4" width="16" height="16" rx="3" stroke="rgba(148,163,184,0.75)" stroke-width="1.4" />
              <rect x="8" y="8" width="8" height="8" rx="1.6" stroke="#22c55e" stroke-width="1.4" />
              <circle cx="12" cy="12" r="1.4" fill="#22c55e" />
            </svg>
          </div>
          <div class="title-block">
            <h1 class="title">BLIP Control Panel</h1>
            <p class="subtitle">
              Live settings, OSC control and firmware updates ‚Äî without touching your stored config.
            </p>
          </div>
          <div class="badge">Online</div>
        </div>

        <div class="controls-row">
          <div class="action-stack">
            <button type="button" class="btn btn-primary" onclick="sendCommand('/settings/save'); restartDevice();">
              Save &amp; Restart
            </button>
            <button type="button" class="btn" onclick="sendCommand('/settings/save');">
              Save Settings
            </button>
            <button type="button" class="btn" onclick="restartDevice();">
              Restart
            </button>
            <button type="button" class="btn btn-danger" onclick="sendCommand('/shutdown');">
              Shutdown
            </button>
          </div>

          <div class="device-meta" aria-live="polite">
            <div class="meta-item">
              <span class="meta-label">IP</span>
              <span class="meta-value" id="deviceMetaIp">‚Äî</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Device ID</span>
              <span class="meta-value" id="deviceMetaId">‚Äî</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Name</span>
              <span class="meta-value" id="deviceMetaName">‚Äî</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Type</span>
              <span class="meta-value" id="deviceMetaType">‚Äî</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Prop ID</span>
              <span class="meta-value" id="deviceMetaProp">‚Äî</span>
            </div>
          </div>

          <div class="server-version-panel" id="serverVersionCard" aria-live="polite">
            <div class="server-version-summary">
              <div>
                <span class="meta-label">Dashboard build</span>
                <span class="server-version-value" id="serverVersionLocal">‚Äî</span>
              </div>
              <div>
                <span class="meta-label">Latest online</span>
                <span class="server-version-value" id="serverVersionRemote">Checking‚Ä¶</span>
              </div>
            </div>
            <p class="server-version-status" id="serverVersionStatus">Looking up available dashboard bundle‚Ä¶</p>
            <div class="server-version-actions">
              <button class="btn btn-primary btn-compact" id="serverVersionAction" disabled>
                Download latest build
              </button>
              <button class="btn btn-compact" id="serverUploadAction" disabled>
                Upload to device
              </button>
            </div>
            <p class="server-version-status subtle" id="serverUploadStatus">Upload not started.</p>
            <div class="bleeding-edge-panel" id="bleedingEdgePanel">
              <div class="bleeding-edge-text">
                <span class="meta-label">Bleeding edge build</span>
                <p class="server-version-status subtle" id="bleedingEdgeStatus">Checking master branch build‚Ä¶</p>
              </div>
              <button class="btn btn-compact" id="bleedingEdgeAction" disabled>
                Download bleeding edge
              </button>
            </div>
          </div>

          <div class="toggle-wrap">
            <span class="toggle-label">Show config</span>
            <label class="toggle">
              <input id="showConfig" type="checkbox" checked />
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- OTA firmware uploader -->
    <div class="card firmware-card" id="firmwareCard" data-collapsed="true">
      <div class="card-inner">
        <div class="section-title firmware-title-row">
          <span>Firmware update</span>
          <button type="button" class="collapse-toggle" id="firmwareToggle" aria-expanded="false" aria-controls="firmwareBody">
            <span id="firmwareToggleLabel">Show panel</span>
            <svg class="collapse-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M8 10l4 4 4-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
        </div>

        <div class="firmware-body" id="firmwareBody">
          <div class="firmware-status" id="firmwareStatus">
            <div>
              <div class="firmware-label">Device firmware</div>
              <div class="firmware-value" id="currentFirmwareVersion">‚Äî</div>
            </div>
            <div>
              <div class="firmware-label">Latest available</div>
              <div class="firmware-value" id="latestFirmwareVersion">‚Äî</div>
            </div>
            <div class="status-pill" id="firmwareStatusPill">Checking‚Ä¶</div>
          </div>
          <div class="status-helper" id="firmwareStatusMessage">Checking firmware status‚Ä¶</div>
          <div class="firmware-actions">
            <div class="firmware-action">
              <div class="action-heading">
                <span class="action-title">Manual package</span>
                <span class="action-tag">.zip download</span>
              </div>
              <div class="action-controls">
                <select id="firmwareVersionSelect" disabled>
                  <option>Loading versions‚Ä¶</option>
                </select>
                <button class="btn-download" id="downloadFirmwareBtn" disabled>Download .zip</button>
              </div>
              <div class="action-status" id="downloadFirmwareStatus">Firmware download link activates once the device is matched to a catalog entry.</div>
            </div>
            <div class="firmware-action">
              <div class="action-heading">
                <span class="action-title">One-click OTA</span>
                <span class="action-tag">Download &amp; install</span>
              </div>
              <button class="btn-download wide" id="autoUpdateBtn" disabled>Download &amp; Install Latest</button>
              <div class="action-status" id="autoUpdateStatus">Auto-update will enable when a newer firmware is available.</div>
            </div>
          </div>

          <div class="firmware-actions upload-actions">
            <div class="firmware-action">
              <div class="action-heading">
                <span class="action-title">Local firmware</span>
                <span class="action-tag">.bin upload</span>
              </div>
              <div class="file-row">
                <label class="file-label" for="firmware">
                  <span class="icon">üìÅ</span>
                  <span>
                    <span class="text-strong">Choose firmware</span>
                    <span style="display:block;font-size:0.75rem;color:var(--text-soft);">
                      ESP32 <code>.bin</code> built with your current partition table
                    </span>
                  </span>
                </label>
                <input type="file" id="firmware" accept=".bin" />
              </div>
              <div class="file-meta" id="fileMeta">
                <span class="file-pill muted">No file selected</span>
              </div>
            </div>

            <div class="firmware-action">
              <div class="action-heading">
                <span class="action-title">Upload progress</span>
                <span class="action-tag">Device OTA</span>
              </div>
              <div class="progress-wrapper">
                <div class="progress-bar" aria-hidden="true">
                  <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text">
                  <span id="progressLabel">Waiting for upload‚Ä¶</span>
                  <span class="value" id="progressValue">0%</span>
                </div>
              </div>
              <div class="footer-row">
                <div class="status" id="statusText">
                  <strong>Status:</strong> idle
                </div>
                <button class="btn-upload" id="uploadBtn" disabled>
                  <span id="uploadBtnLabel">Upload firmware</span>
                  <span id="uploadSpinner" class="spinner" style="display:none;"></span>
                </button>
              </div>
              <div class="hint-row compact">
                <span class="hint-pill">Tip</span>
                <span>Device will reboot automatically after a successful OTA flash.</span>
              </div>
              <div class="file-meta" id="uploadMessage">No upload in progress.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Editor / parameters -->
    <div class="card editor-card">
      <div class="card-inner">
        <div class="section-title">Live parameters</div>
        <div id="editor">Connecting‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- Logger Toggle Button -->
  <button class="logger-toggle" id="loggerToggle" title="Toggle Debug Logger">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </svg>
  </button>

  <!-- Logger Panel -->
  <div class="logger-panel" id="loggerPanel">
    <div class="logger-header">
      <h3>Debug Logger</h3>
      <button class="logger-close" id="loggerClose">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="logger-controls">
      <button class="btn btn-danger" id="clearLogs">Clear</button>
      <input type="text" id="logFilter" placeholder="Filter logs" aria-label="Filter log entries" />
      <button class="btn" id="showStatsBtn">Show stats</button>
      <span style="flex: 1; font-size: 0.75rem; color: var(--text-soft);">
        <span id="logCount">0</span> entries
      </span>
    </div>
    <div class="logger-content" id="loggerContent">
      <div class="log-entry info">
        <span class="log-source">System</span>
        <span class="log-message">Logger ready. Waiting for messages...</span>
      </div>
    </div>
  </div>

  <script src="edit.js"></script>

</body>

</html>